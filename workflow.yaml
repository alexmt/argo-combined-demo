apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: arguments-parameters-
spec:
  entrypoint: main

  arguments:
    parameters:
    - name: path
      value: input.jpg

  templates:
  - name: main
    steps:
    - - name: find-faces
        template: find-faces
        arguments:
          parameters:
          - name: path
            value: "{{workflow.parameters.path}}"

    - - name: upload-result
        template: upload-result
        arguments:
          artifacts:
          - name: file
            from: "{{steps.find-faces.outputs.artifacts.photo}}"
        

  - name: find-faces
    inputs:
      parameters:
      - name: path
      artifacts:
      - name: photo
        path: /photo.jpg
        s3:
          endpoint: kubecon-demo-minio:9000
          insecure: true
          bucket: kubecon-demo
          key: "{{inputs.parameters.path}}"
          accessKeySecret:
            name: kubecon-demo-minio
            key: accesskey
          secretKeySecret:
            name: kubecon-demo-minio
            key: secretkey
    container:
      image: alexmt/facedetect
      command: [python]
      args: ["/app/facedetect", "-o", "/result.jpg", "photo.jpg"]
    outputs:
      artifacts:
      - name: photo
        path: "/result.jpg"

  - name: upload-result
    inputs:
      artifacts:
      - name: file
        path: /tmp/file
    container:
      env:
      - name: AWS_ACCESS_KEY_ID
        valueFrom:
          secretKeyRef:
            name: kubecon-demo-minio
            key: accesskey
      - name: AWS_SECRET_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: kubecon-demo-minio
            key: secretkey
      image: amazon/aws-cli
      command: [aws]
      args: ["--endpoint-url", "http://kubecon-demo-minio:9000/", "s3", "cp", "/tmp/file", "s3://kubecon-demo/{{workflow.parameters.path}}-PROCESSED.jpg"]